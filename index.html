<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#10B981">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ›’</text></svg>">
    
    <title>Keranjang Kita - Keluarga</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@400;600;700&family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        /* Optimasi Scroll & Touch */
        html, body { overscroll-behavior-y: none; touch-action: manipulation; }
        body { 
            font-family: 'Quicksand', sans-serif; 
            background-color: #f0fdf4; 
            display: flex; 
            justify-content: center; 
            min-height: 100vh; 
            min-height: 100dvh; 
            margin: 0; 
            background-image: radial-gradient(#10B981 0.5px, transparent 0.5px); 
            background-size: 20px 20px; 
            overflow-x: hidden;
        }
        #app-wrapper { 
            width: 100%; 
            max-width: 480px; 
            background-color: white; 
            height: 100vh; 
            height: 100dvh; 
            position: relative; 
            box-shadow: 0 0 40px rgba(0,0,0,0.1); 
            display: flex; 
            flex-direction: column; 
            overflow: hidden; 
        }
        
        /* Scrollbar Halus */
        ::-webkit-scrollbar { width: 4px; height: 4px; } 
        ::-webkit-scrollbar-track { background: transparent; } 
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Animasi */
        .fade-in { animation: fadeIn 0.3s ease-out; } @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .slide-up { animation: slideUp 0.3s ease-out; } @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        /* FAB */
        .fab { 
            position: fixed; 
            bottom: calc(30px + env(safe-area-inset-bottom)); 
            right: 20px; 
            width: 64px; height: 64px; 
            background: linear-gradient(135deg, #10B981, #059669); 
            border-radius: 50%; 
            display: flex; align-items: center; justify-content: center; 
            color: white; font-size: 28px; 
            box-shadow: 0 8px 20px rgba(16, 185, 129, 0.4); 
            cursor: pointer; z-index: 40; 
            transition: transform 0.2s; 
            -webkit-tap-highlight-color: transparent; 
        }
        .fab:active { transform: scale(0.90); }
        @media (min-width: 480px) { .fab { right: calc(50% - 220px); bottom: 40px; } .fab:hover { transform: scale(1.1) rotate(90deg); } }
        
        /* Components */
        .requester-btn { transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1); border: 3px solid transparent; opacity: 0.9; transform: scale(1); position: relative; z-index: 1; }
        .requester-btn.active { border-color: #10B981; background-color: #ecfdf5; opacity: 1; transform: scale(1.1); box-shadow: 0 8px 20px -5px rgba(16, 185, 129, 0.3); z-index: 10; }
        .badge-user { font-size: 0.7rem; padding: 2px 8px; border-radius: 12px; font-weight: 700; display: inline-block; margin-top: 4px; }
        
        /* Toast */
        #toast { visibility: hidden; min-width: 200px; background-color: #333; color: #fff; text-align: center; border-radius: 50px; padding: 12px; position: fixed; z-index: 100; left: 50%; bottom: 100px; transform: translateX(-50%); font-size: 14px; opacity: 0; transition: 0.3s; }
        #toast.show { visibility: visible; opacity: 1; bottom: 110px; }
        
        /* --- INTEGRASI CSS STRUK --- */
        .font-receipt { font-family: 'Inconsolata', monospace; }
        
        .receipt-paper {
            background: #fff;
            position: relative;
            border: 1px solid #eee;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            width: 100%;
            -webkit-print-color-adjust: exact;
            print-color-adjust: exact;
        }
        
        .receipt-paper::after {
            content: ""; position: absolute; left: 0; bottom: -8px; width: 100%; height: 10px;
            background: radial-gradient(circle, transparent, transparent 50%, #fff 50%, #fff 100%) -7px -2px / 15px 15px repeat-x;
            filter: drop-shadow(0 2px 0 #ddd); z-index: 1;
            -webkit-print-color-adjust: exact; print-color-adjust: exact;
        }
        
        .receipt-table { width: 100%; border-collapse: collapse; margin-bottom: 10px; }
        .receipt-table td { padding: 6px 0; vertical-align: top; font-size: 13px; font-family: 'Inconsolata', monospace; border-bottom: 1.5px dashed #9ca3af; color: #333; }
        .receipt-table tr:last-child td { border-bottom: none; }
        .col-item { width: 55%; text-align: left; padding-right: 5px; font-weight: bold; }
        .col-user { width: 15%; text-align: right; color: #6b7280; font-size: 11px; white-space: nowrap; font-style: italic; }
        .col-price { width: 30%; text-align: right; font-weight: bold; color: #111827; }

        /* Utils & Scroll */
        .drag-handle { cursor: grab; touch-action: none; }
        .scroll-btn { position: absolute; top: 50%; transform: translateY(-50%); width: 36px; height: 36px; background: rgba(255,255,255,0.95); border-radius: 50%; box-shadow: 0 4px 15px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: center; color: #10B981; cursor: pointer; z-index: 30; transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); border: 1px solid #e5e7eb; }
        .scroll-btn:hover { background: #fff; transform: translateY(-50%) scale(1.15); box-shadow: 0 6px 20px rgba(0,0,0,0.2); color: #059669; }
        .scroll-btn:active { transform: translateY(-50%) scale(0.95); }
        .scroll-btn.hidden { display: none !important; opacity: 0; pointer-events: none; }
        .fade-mask-right { position: absolute; right: 0; top: 0; bottom: 0; width: 60px; background: linear-gradient(to right, transparent, rgba(255,255,255,1)); pointer-events: none; z-index: 20; transition: opacity 0.3s; }

        @keyframes float { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(-10px); } }
        .animate-float { animation: float 3s ease-in-out infinite; }
        .animate-shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both infinite; }
        @keyframes shake { 10%, 90% { transform: translate3d(-1px, 0, 0); } 20%, 80% { transform: translate3d(2px, 0, 0); } 30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 40%, 60% { transform: translate3d(4px, 0, 0); } }
    </style>
</head>
<body>

    <div id="app-wrapper">
        <div id="main-app" class="flex flex-col h-full fade-in">
            <header class="bg-gradient-to-r from-green-500 to-emerald-600 text-white p-6 rounded-b-[40px] shadow-lg z-10 sticky top-0">
                <div class="flex justify-between items-center mb-4">
                    <div>
                        <p class="text-green-100 text-xs mb-1 font-semibold tracking-wider">Gak Ada Lagi Drama 'Lupa Titipan'</p>
                        <h1 class="text-2xl font-bold">Keranjang Kita ğŸ›’</h1>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="window.openReportModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full backdrop-blur-sm transition-transform active:scale-90 cursor-pointer" title="Laporan"><i class="fas fa-chart-pie text-white"></i></button>
                        <button onclick="window.openResetModal()" class="bg-white/20 hover:bg-white/30 p-2 rounded-full backdrop-blur-sm transition-transform active:scale-90 cursor-pointer" title="Mulai Baru"><i class="fas fa-redo-alt text-white"></i></button>
                    </div>
                </div>
                <div class="bg-black/20 p-4 rounded-2xl backdrop-blur-md cursor-pointer hover:bg-black/30 transition-colors group" onclick="window.openReportModal()" title="Klik untuk lihat Laporan">
                    <div class="flex justify-between items-end mb-3 pb-3 border-b border-white/20">
                        <div>
                            <div class="flex items-center gap-1 mb-1 opacity-80">
                                <p class="text-[10px] text-green-100 uppercase tracking-wide">Uang Keluar (Beban)</p>
                                <i class="fas fa-check-circle text-[10px] text-green-200"></i>
                            </div>
                            <p class="text-3xl font-bold text-yellow-300 truncate max-w-[200px]" id="total-spent">Rp 0</p>
                        </div>
                        <div class="text-right">
                            <div class="flex flex-col items-end">
                                <p class="text-[10px] text-green-100 uppercase tracking-wide mb-1 opacity-80">Item Dibeli</p>
                                <p class="text-xl font-bold text-white" id="item-count">0</p>
                            </div>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs mb-2 font-semibold text-green-50">
                        <span id="progress-text">0/0 Selesai</span>
                        <span id="progress-percent">0%</span>
                    </div>
                    <div class="w-full bg-white/20 rounded-full h-2.5 overflow-hidden">
                        <div id="progress-bar" class="bg-white h-full rounded-full transition-all duration-700 w-0"></div>
                    </div>
                </div>
            </header>

            <main class="flex-1 p-5 pb-32 overflow-y-auto" id="shopping-list">
                <div id="empty-state" class="hidden flex flex-col items-center justify-center mt-20 text-gray-400 opacity-60">
                    <i class="fas fa-shopping-cart text-6xl mb-4 text-green-200"></i>
                    <p class="font-medium">Keranjang masih kosong.</p>
                    <p class="text-sm">Klik tombol + untuk mulai.</p>
                </div>
            </main>

            <button class="fab" onclick="window.openModal()"><i class="fas fa-plus"></i></button>
        </div>

        <div id="modal" class="fixed inset-0 bg-black/60 hidden items-end justify-center z-50 backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-[480px] h-auto max-h-[90vh] rounded-t-[30px] slide-up shadow-2xl flex flex-col touch-pan-y">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-4 mb-2 drag-handle shrink-0"></div>
                <div class="p-6 pt-0 pb-0 flex-none">
                    <h3 class="text-xl font-bold mb-4 text-gray-800 shrink-0">Tambah Titipan</h3>
                    <div class="relative mb-6 shrink-0">
                        <label class="text-xs font-bold text-gray-400 ml-1 mb-1 block">NAMA BARANG</label>
                        <input type="text" id="input-item" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-3 pl-12 pr-4 text-lg font-medium focus:outline-none focus:border-green-500 focus:bg-white transition-colors" placeholder="Misal: Beras 5kg..." autocomplete="off">
                        <i class="fas fa-shopping-bag absolute left-4 top-[38px] text-gray-400"></i>
                    </div>
                </div>
                <div class="px-6 flex-1 overflow-y-auto no-scrollbar">
                    <label class="text-xs font-bold text-gray-400 ml-1 mb-3 block">SIAPA YANG NITIP?</label>
                    <div class="relative group w-full">
                        <div id="fade-right" class="fade-mask-right"></div>
                        <button id="scroll-left-btn" class="scroll-btn hidden -left-3" onclick="window.scrollRequesterList(-1)"><i class="fas fa-chevron-left"></i></button>
                        <div id="requester-scroll-container" class="flex overflow-x-auto overflow-y-hidden py-4 gap-4 no-scrollbar scroll-smooth snap-x snap-mandatory pr-10" onscroll="window.checkScrollPosition()">
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Saya', 'ğŸ˜Š', 'bg-cyan-50 text-cyan-700', this)" class="requester-btn w-16 h-16 rounded-full bg-cyan-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ˜Š</button><span class="text-[11px] font-bold text-gray-600">Saya</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Ayah', 'ğŸ‘¨ğŸ»', 'bg-blue-100 text-blue-700', this)" class="requester-btn active w-16 h-16 rounded-full bg-blue-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘¨ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Ayah</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Bunda', 'ğŸ‘©ğŸ»', 'bg-pink-100 text-pink-700', this)" class="requester-btn w-16 h-16 rounded-full bg-pink-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘©ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Bunda</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Kakak', 'ğŸ‘¦ğŸ»', 'bg-yellow-100 text-yellow-700', this)" class="requester-btn w-16 h-16 rounded-full bg-yellow-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘¦ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Kakak</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Adek', 'ğŸ‘§ğŸ»', 'bg-purple-100 text-purple-700', this)" class="requester-btn w-16 h-16 rounded-full bg-purple-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘§ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Adek</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Kakek', 'ğŸ‘´ğŸ»', 'bg-gray-100 text-gray-700', this)" class="requester-btn w-16 h-16 rounded-full bg-gray-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘´ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Kakek</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Nenek', 'ğŸ‘µğŸ»', 'bg-orange-100 text-orange-700', this)" class="requester-btn w-16 h-16 rounded-full bg-orange-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘µğŸ»</button><span class="text-[11px] font-bold text-gray-600">Nenek</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Pakdhe', 'ğŸ‘¨ğŸ»â€ğŸ¦±', 'bg-indigo-100 text-indigo-700', this)" class="requester-btn w-16 h-16 rounded-full bg-indigo-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘¨ğŸ»â€ğŸ¦±</button><span class="text-[11px] font-bold text-gray-600">Pakdhe</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Budhe', 'ğŸ‘©ğŸ»â€ğŸ¦±', 'bg-amber-100 text-amber-700', this)" class="requester-btn w-16 h-16 rounded-full bg-amber-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘©ğŸ»â€ğŸ¦±</button><span class="text-[11px] font-bold text-gray-600">Budhe</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Om', 'ğŸ§”ğŸ»', 'bg-teal-100 text-teal-700', this)" class="requester-btn w-16 h-16 rounded-full bg-teal-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ§”ğŸ»</button><span class="text-[11px] font-bold text-gray-600">Om</span></div>
                            <div class="flex flex-col items-center gap-2 min-w-[76px] snap-start shrink-0"><button onclick="window.selectRequester('Tante', 'ğŸ‘±ğŸ»â€â™€ï¸', 'bg-rose-100 text-rose-700', this)" class="requester-btn w-16 h-16 rounded-full bg-rose-50 flex items-center justify-center text-3xl shadow-sm border-2 border-transparent">ğŸ‘±ğŸ»â€â™€ï¸</button><span class="text-[11px] font-bold text-gray-600">Tante</span></div>
                        </div>
                        <button id="scroll-right-btn" class="scroll-btn hidden -right-3" onclick="window.scrollRequesterList(1)"><i class="fas fa-chevron-right"></i></button>
                    </div>
                    <div class="flex justify-center gap-1.5 mt-1" id="scroll-dots">
                         <div class="scroll-dot w-2 h-2 rounded-full bg-green-500 transition-all duration-300"></div>
                         <div class="scroll-dot w-2 h-2 rounded-full bg-gray-300 scale-75 transition-all duration-300"></div>
                         <div class="scroll-dot w-2 h-2 rounded-full bg-gray-300 scale-75 transition-all duration-300"></div>
                    </div>
                    <div class="relative mt-4 mb-4">
                        <input type="text" id="custom-requester-input" class="w-full bg-gray-50 border-2 border-gray-100 rounded-2xl py-3 pl-10 pr-4 text-sm font-medium focus:outline-none focus:border-green-500 focus:bg-white transition-colors" placeholder="Atau tulis nama manual..." autocomplete="off" oninput="window.handleCustomRequester(this)">
                        <i class="fas fa-edit absolute left-4 top-1/2 -translate-y-1/2 text-gray-400"></i>
                    </div>
                </div>
                <div class="p-6 pt-0 mt-auto flex-none">
                    <div class="flex gap-3">
                        <button onclick="window.closeModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100 hover:bg-gray-200 active:scale-95 transition-transform">Batal</button>
                        <button onclick="window.addItem()" class="flex-1 py-3 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 active:scale-95 transition-transform shadow-lg shadow-green-200">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="price-modal" class="fixed inset-0 bg-black/60 hidden items-center justify-center z-50 backdrop-blur-sm p-4 transition-opacity">
            <div class="bg-white w-full max-w-sm p-6 rounded-3xl shadow-2xl transform scale-100 animate-bounce-small">
                <div class="text-center mb-6">
                    <div class="w-16 h-16 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-3"><i class="fas fa-tags text-green-600 text-2xl"></i></div>
                    <h3 class="text-xl font-bold text-gray-800" id="price-item-name">Nama Barang</h3>
                    <p class="text-sm text-gray-500">Masukkan Harga Beli (Realita)</p>
                </div>
                <div class="relative mb-6">
                    <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">Rp</span>
                    <input type="text" inputmode="numeric" pattern="[0-9]*" id="checklist-price-input" class="w-full bg-gray-50 border-2 border-green-200 rounded-2xl py-4 pl-12 pr-4 text-2xl font-bold text-gray-800 focus:outline-none focus:border-green-500 focus:bg-white transition-colors text-center" placeholder="0" autocomplete="off" oninput="window.formatRupiahTyping(this)">
                </div>
                <button onclick="window.confirmItemPrice()" class="w-full py-4 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 active:scale-95 transition-transform shadow-lg shadow-green-200">Oke, Sudah Dibeli! <i class="fas fa-check ml-1"></i></button>
            </div>
        </div>

        <div id="reimburse-modal" class="fixed inset-0 bg-black/60 hidden items-end justify-center z-[60] backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-[480px] rounded-t-[30px] slide-up shadow-2xl h-[85vh] flex flex-col touch-pan-y relative overflow-hidden">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-4 mb-2 drag-handle flex-none"></div>
                <div class="text-center mb-4 flex-none px-6">
                    <div class="w-12 h-12 bg-blue-100 rounded-full flex items-center justify-center mx-auto mb-2"><i class="fas fa-hand-holding-usd text-blue-600 text-xl"></i></div>
                    <h3 class="text-xl font-bold text-gray-800">Catat Ganti Uang</h3>
                    <p class="text-xs text-gray-500">Pilih riwayat belanja yang ingin diganti</p>
                    <p class="text-[10px] text-red-400 mt-1 italic">*Barang milik "Saya" tidak muncul di sini</p>
                </div>
                <div id="reimburse-view-list" class="flex-1 overflow-y-auto px-6"></div>
                <div id="reimburse-view-detail" class="flex-1 overflow-y-auto px-6 hidden flex-col">
                    <button onclick="window.backToReimburseList()" class="mb-4 text-sm text-gray-500 flex items-center gap-2 hover:text-gray-800 self-start p-2"><i class="fas fa-arrow-left"></i> Kembali</button>
                    <div id="reimburse-items-container"></div>
                </div>
                <div class="p-6 bg-white flex-none z-10 w-full border-t border-gray-100 hidden" id="reimburse-footer">
                    <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-gray-600">Total Dipilih</span>
                        <span class="font-bold text-xl text-blue-600" id="reimburse-total">Rp 0</span>
                    </div>
                    <div class="flex gap-3">
                        <button onclick="window.closeReimburseModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-500 bg-gray-100 hover:bg-gray-200">Batal</button>
                        <button onclick="window.confirmReimbursement()" class="flex-1 py-3 rounded-xl font-bold text-white bg-blue-600 hover:bg-blue-700 shadow-lg shadow-blue-200">Simpan</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="cancel-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl text-center">
                <div class="w-16 h-16 bg-orange-50 rounded-full flex items-center justify-center mx-auto mb-4 text-orange-500 text-2xl"><i class="fas fa-undo"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Batalkan Pembelian?</h3>
                <p class="text-gray-500 text-sm mb-6">Barang ini akan ditandai kembali sebagai "Belum Dibeli".</p>
                <div class="flex gap-3">
                    <button onclick="window.closeCancelModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 active:scale-95 transition-transform">Jangan</button>
                    <button onclick="window.confirmUncheck()" class="flex-1 py-3 rounded-xl font-bold text-white bg-orange-500 shadow-lg shadow-orange-200 active:scale-95 transition-transform">Ya, Batal</button>
                </div>
            </div>
        </div>

        <div id="reset-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl text-center">
                <div class="w-16 h-16 bg-blue-50 rounded-full flex items-center justify-center mx-auto mb-4 text-blue-500 text-2xl"><i class="fas fa-redo-alt"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Mulai Belanja Baru?</h3>
                <p class="text-gray-500 text-sm mb-6">Barang yang sudah dibeli akan disimpan ke Riwayat. Sisanya akan dihapus.</p>
                <div class="flex gap-3">
                    <button onclick="window.closeResetModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 active:scale-95 transition-transform">Batal</button>
                    <button onclick="window.confirmNewSession()" class="flex-1 py-3 rounded-xl font-bold text-white bg-blue-600 shadow-lg shadow-blue-200 active:scale-95 transition-transform">Ya, Mulai Baru</button>
                </div>
            </div>
        </div>

        <div id="clear-history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[60] backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl text-center">
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl"><i class="fas fa-history"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Semua Riwayat?</h3>
                <p class="text-gray-500 text-sm mb-6">Data riwayat belanja akan hilang permanen dan tidak bisa dikembalikan.</p>
                <div class="flex gap-3">
                    <button onclick="window.closeClearHistoryModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 active:scale-95 transition-transform">Batal</button>
                    <button onclick="window.confirmClearHistory()" class="flex-1 py-3 rounded-xl font-bold text-white bg-red-500 shadow-lg shadow-red-200 active:scale-95 transition-transform">Hapus</button>
                </div>
            </div>
        </div>

        <div id="receipt-modal" class="fixed inset-0 bg-black/80 hidden z-[70] backdrop-blur-sm overflow-y-auto transition-opacity">
            <div class="min-h-screen flex flex-col items-center justify-center p-4 fade-in">
                <div id="receipt-content" class="w-full max-w-sm bg-white relative shadow-2xl receipt-paper mb-6 rounded-t-lg p-6 text-gray-800 shrink-0">
                    <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4 font-receipt">
                        <h2 class="font-bold text-2xl tracking-widest uppercase mb-1 font-sans">KERANJANG KITA</h2>
                        <p class="font-receipt text-xs text-gray-500">Gak Ada Lagi Drama 'Lupa Titipan'</p>
                        <p class="font-receipt text-xs mt-2" id="receipt-date">Tanggal: -</p>
                    </div>
                    <table class="receipt-table"><tbody id="receipt-items-body"></tbody></table>
                    <div class="border-t-2 border-dashed border-gray-400 pt-3 font-receipt mt-4">
                        <div class="flex justify-between font-bold text-lg"><span>TOTAL</span><span id="receipt-total">Rp 0</span></div>
                        <div class="text-center mt-6 text-xs text-gray-500 space-y-1"><p>LUNAS</p><p>Terima Kasih!</p><p>App by Keranjang Kita</p></div>
                    </div>
                </div>
                <div class="w-full max-w-sm flex flex-col gap-3 shrink-0">
                    <div class="grid grid-cols-3 gap-3">
                        <button onclick="window.saveAsImage()" class="flex flex-col items-center justify-center bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-xl transition-transform active:scale-95 shadow-lg"><i class="fas fa-image text-xl mb-1"></i><span class="text-[10px] font-bold">Gambar</span></button>
                        <button onclick="window.printReceipt()" class="flex flex-col items-center justify-center bg-red-500 hover:bg-red-600 text-white p-3 rounded-xl transition-transform active:scale-95 shadow-lg"><i class="fas fa-file-pdf text-xl mb-1"></i><span class="text-[10px] font-bold">PDF/Print</span></button>
                        <button onclick="window.copyReceiptText()" class="flex flex-col items-center justify-center bg-green-600 hover:bg-green-700 text-white p-3 rounded-xl transition-transform active:scale-95 shadow-lg"><i class="fas fa-copy text-xl mb-1"></i><span class="text-[10px] font-bold">Salin Teks</span></button>
                    </div>
                    <button onclick="window.closeReceiptModal()" class="w-full py-3 rounded-xl font-bold text-gray-700 bg-gray-100 border-2 border-gray-200 hover:bg-gray-200 transition-colors shadow-lg mb-8">Tutup Struk</button>
                </div>
            </div>
            <div id="receipt-print-target" class="fixed top-0 left-[-9999px] w-[380px] bg-white p-6 pointer-events-none receipt-paper z-[-1] opacity-100 text-gray-800" style="display: block;">
                 <div class="text-center border-b-2 border-dashed border-gray-400 pb-4 mb-4 font-receipt">
                    <h2 class="font-bold text-2xl tracking-widest uppercase mb-1 font-sans">KERANJANG KITA</h2>
                    <p class="font-receipt text-xs text-gray-500">Gak Ada Lagi Drama 'Lupa Titipan'</p>
                    <p class="font-receipt text-xs mt-2" id="print-date">Tanggal: -</p>
                </div>
                <table class="receipt-table"><tbody id="print-items-body"></tbody></table>
                <div class="border-t-2 border-dashed border-gray-400 pt-3 font-receipt mt-4">
                    <div class="flex justify-between font-bold text-lg"><span>TOTAL</span><span id="print-total">Rp 0</span></div>
                    <div class="text-center mt-6 text-xs text-gray-500 space-y-1"><p>LUNAS</p><p>Terima Kasih!</p><p>App by Keranjang Kita</p></div>
                </div>
            </div>
        </div>

        <div id="report-modal" class="fixed inset-0 bg-black/60 hidden items-end justify-center z-50 backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-[480px] rounded-t-[30px] slide-up shadow-2xl h-[85dvh] flex flex-col touch-pan-y">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mt-4 mb-2 drag-handle flex-none"></div>
                <div class="flex justify-between items-center mb-6 px-6 flex-none">
                    <h3 class="text-xl font-bold text-gray-800">Laporan Keuangan</h3>
                    <button onclick="window.closeReportModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fas fa-times"></i></button>
                </div>
                <div class="flex-1 overflow-y-auto px-6">
                    <div class="bg-gradient-to-br from-blue-500 to-blue-600 p-5 rounded-2xl text-white shadow-lg mb-4 relative overflow-hidden">
                        <i class="fas fa-calendar-day absolute -right-4 -bottom-4 text-8xl text-white opacity-10"></i>
                        <p class="text-blue-100 text-xs font-bold uppercase tracking-wider mb-1">HARI INI (BERSIH)</p>
                        <h2 class="text-3xl font-bold" id="report-today">Rp 0</h2>
                        <p class="text-[10px] text-blue-100 mt-1 opacity-80">Total Pengeluaran - Yang Sudah Diganti</p>
                    </div>
                    <div id="month-banner" class="bg-gradient-to-br from-green-500 to-emerald-600 p-5 rounded-2xl text-white shadow-lg mb-6 relative overflow-hidden transition-all duration-500">
                        <i class="fas fa-chart-line absolute -right-4 -bottom-4 text-8xl text-white opacity-10"></i>
                        <div id="month-emotion" class="text-6xl absolute right-4 top-1/2 -translate-y-1/2 opacity-80 filter drop-shadow-md transition-all duration-500">ğŸ˜</div>
                        <p class="text-white/80 text-xs font-bold uppercase tracking-wider mb-1">BULAN INI (BERSIH)</p>
                        <h2 class="text-3xl font-bold" id="report-month">Rp 0</h2>
                        <p id="month-status" class="text-sm mt-2 font-medium bg-white/20 inline-block px-2 py-1 rounded-lg backdrop-blur-sm">Aman Sentosa</p>
                    </div>
                    <div class="mb-6">
                        <div class="flex justify-between items-end mb-3">
                            <h4 class="font-bold text-gray-700 text-sm uppercase tracking-wide">Pemasukan (Ganti Uang)</h4>
                            <span class="text-xs text-blue-600 font-bold bg-blue-50 px-2 py-1 rounded-lg" id="total-income">Total: Rp 0</span>
                        </div>
                        <button onclick="window.openReimburseModal()" class="w-full py-3 border-2 border-dashed border-blue-300 text-blue-600 font-bold rounded-xl hover:bg-blue-50 transition-colors flex items-center justify-center gap-2"><i class="fas fa-hand-holding-usd"></i> Catat Ganti Uang (Pilih Barang)</button>
                    </div>
                    <div class="border-t border-gray-100 pt-4">
                        <h4 class="font-bold text-gray-700 mb-3 text-sm uppercase tracking-wide">Riwayat Belanja</h4>
                        <div id="history-list" class="space-y-3 text-sm"></div>
                    </div>
                </div>
                <div class="p-6 pt-2 flex-none">
                     <button onclick="window.openClearHistoryModal()" class="w-full py-3 rounded-xl font-bold text-red-500 bg-red-50 hover:bg-red-100 text-sm transition-colors">Hapus Semua Riwayat</button>
                </div>
            </div>
        </div>

        <div id="history-detail-modal" class="fixed inset-0 bg-black/60 hidden items-end justify-center z-[55] backdrop-blur-sm transition-opacity">
            <div class="bg-white w-full max-w-[480px] p-6 rounded-t-[30px] slide-up shadow-2xl h-[70dvh] flex flex-col touch-pan-y">
                <div class="w-12 h-1.5 bg-gray-200 rounded-full mx-auto mb-4 drag-handle"></div>
                <div class="flex justify-between items-center mb-4 flex-none">
                    <h3 class="text-xl font-bold text-gray-800">Detail Belanja</h3>
                    <button onclick="window.closeHistoryDetailModal()" class="w-8 h-8 rounded-full bg-gray-100 flex items-center justify-center text-gray-500 hover:bg-gray-200"><i class="fas fa-times"></i></button>
                </div>
                <div class="bg-gray-50 p-4 rounded-xl mb-4 border border-gray-100 flex-none">
                    <p class="text-xs text-gray-500 mb-1">Waktu Transaksi</p>
                    <p class="font-bold text-gray-800" id="detail-date">-</p>
                </div>
                <div class="flex-1 overflow-y-auto pr-1 mb-4">
                    <div id="detail-items-list" class="space-y-2"></div>
                </div>
                <div class="border-t pt-4 flex-none">
                     <div class="flex justify-between items-center mb-4">
                        <span class="font-bold text-gray-600">Total</span>
                        <span class="font-bold text-xl text-green-600" id="detail-total">Rp 0</span>
                     </div>
                     <button id="btn-view-receipt-history" class="w-full py-3 rounded-xl font-bold text-white bg-green-600 hover:bg-green-700 shadow-lg shadow-green-200 flex items-center justify-center gap-2 transition-transform active:scale-95"><i class="fas fa-receipt"></i> Lihat / Cetak Struk</button>
                </div>
            </div>
        </div>

        <div id="delete-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-50 backdrop-blur-sm p-4">
            <div class="bg-white w-full max-w-xs p-6 rounded-3xl shadow-2xl text-center transform scale-100">
                <div class="w-16 h-16 bg-red-50 rounded-full flex items-center justify-center mx-auto mb-4 text-red-500 text-2xl"><i class="fas fa-trash-alt"></i></div>
                <h3 class="text-lg font-bold text-gray-800 mb-2">Hapus Barang?</h3>
                <p class="text-gray-500 text-sm mb-6">Barang ini akan dihapus permanen.</p>
                <div class="flex gap-3">
                    <button onclick="window.closeDeleteModal()" class="flex-1 py-3 rounded-xl font-bold text-gray-600 bg-gray-100 active:scale-95 transition-transform">Batal</button>
                    <button onclick="window.confirmDelete()" class="flex-1 py-3 rounded-xl font-bold text-white bg-red-500 shadow-lg shadow-red-200 active:scale-95 transition-transform">Hapus</button>
                </div>
            </div>
        </div>
        
        <div id="celebration-modal" class="fixed inset-0 bg-black/70 hidden items-center justify-center z-[60] backdrop-blur-md p-6">
            <div class="bg-white w-full max-w-sm p-8 rounded-[40px] shadow-2xl text-center relative overflow-hidden">
                <div class="absolute top-0 left-0 w-full h-full pointer-events-none overflow-hidden"><div class="absolute -top-4 left-[10%] animate-[fall_3s_infinite]">ğŸ‰</div><div class="absolute -top-4 left-[30%] animate-[fall_2.5s_infinite_0.5s]">âœ¨</div><div class="absolute -top-4 left-[70%] animate-[fall_3.2s_infinite_0.2s]">ğŸŠ</div></div>
                <div class="text-6xl mb-4 animate-bounce">ğŸ†</div>
                <h2 class="text-2xl font-bold text-gray-800 mb-1">Semua Beres!</h2>
                <p class="text-gray-500 mb-6 text-sm">Hati-hati di jalan, sampai jumpa!</p>
                <div class="bg-green-50 p-4 rounded-2xl mb-6 border border-green-100">
                    <p class="text-xs text-green-600 font-bold uppercase tracking-wide mb-1">Total Belanjaan Hari Ini</p>
                    <p class="text-3xl font-extrabold text-green-700" id="celebration-total-price">Rp 0</p>
                </div>
                <div class="grid grid-cols-2 gap-3 mt-4">
                    <button onclick="window.openReceiptModal()" class="py-3 rounded-xl font-bold text-green-600 bg-green-50 hover:bg-green-100 transition-colors">Lihat Struk</button>
                    <button onclick="window.closeCelebration()" class="py-3 rounded-xl font-bold text-white bg-gradient-to-r from-yellow-400 to-orange-500 shadow-xl transition-transform hover:scale-105">Tutup</button>
                </div>
            </div>
        </div>

        <div id="toast">Berhasil!</div>
    </div>

    <script>
        // --- DATA & STATE ---
        let items = [];
        let expenseHistory = [];
        let incomeHistory = []; 
        let currentReimburseIndex = null; 
        
        try {
            const lsItems = localStorage.getItem('familyItems');
            if (lsItems) items = JSON.parse(lsItems);
            
            const lsExp = localStorage.getItem('familyExpenses');
            if (lsExp) expenseHistory = JSON.parse(lsExp);
            
            const lsInc = localStorage.getItem('familyIncomes');
            if (lsInc) incomeHistory = JSON.parse(lsInc);
        } catch(e) {
            console.warn('LocalStorage error:', e);
            items = []; expenseHistory = []; incomeHistory = [];
        }

        let itemToDeleteIndex = null;
        let itemToPriceIndex = null;
        let itemToUncheckIndex = null;
        let currentRequester = { name: 'Ayah', emoji: 'ğŸ‘¨ğŸ»', colorClass: 'bg-blue-100 text-blue-700' };
        let currentDetailIndex = null;

        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function resumeAudioContext() {
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        const getEl = (id) => document.getElementById(id);
        
        const DOM = {
            list: getEl('shopping-list'),
            empty: getEl('empty-state'),
            input: getEl('input-item'),
            customReq: getEl('custom-requester-input'),
            priceInput: getEl('checklist-price-input'),
            priceName: getEl('price-item-name'),
            totalSpent: getEl('total-spent'),
            itemCount: getEl('item-count'),
            progressBar: getEl('progress-bar'),
            progressText: getEl('progress-text'),
            progressPercent: getEl('progress-percent'),
            modal: getEl('modal'),
            deleteModal: getEl('delete-modal'),
            priceModal: getEl('price-modal'),
            cancelModal: getEl('cancel-modal'),
            reimburseModal: getEl('reimburse-modal'),
            receiptModal: getEl('receipt-modal'),
            celebrationModal: getEl('celebration-modal'),
            reportModal: getEl('report-modal'),
            resetModal: getEl('reset-modal'),
            historyDetailModal: getEl('history-detail-modal'),
            clearHistoryModal: getEl('clear-history-modal'),
            reimburseList: getEl('reimburse-view-list'),
            reimburseDetail: getEl('reimburse-view-detail'),
            reimburseFooter: getEl('reimburse-footer'),
            reimburseItemsContainer: getEl('reimburse-items-container'),
            reimburseTotal: getEl('reimburse-total'),
            receiptDate: getEl('receipt-date'),
            receiptBody: getEl('receipt-items-body'),
            receiptTotal: getEl('receipt-total'),
            printDate: getEl('print-date'),
            printBody: getEl('print-items-body'),
            printTotal: getEl('print-total'),
            receiptTarget: getEl('receipt-print-target'),
            reportToday: getEl('report-today'),
            reportMonth: getEl('report-month'),
            totalIncome: getEl('total-income'),
            historyList: getEl('history-list'),
            monthBanner: getEl('month-banner'),
            monthEmotion: getEl('month-emotion'),
            monthStatus: getEl('month-status'),
            detailDate: getEl('detail-date'),
            detailTotal: getEl('detail-total'),
            detailItemsList: getEl('detail-items-list'),
            btnViewReceipt: getEl('btn-view-receipt-history'),
            celTotal: getEl('celebration-total-price')
        };
        
       const emojiMap = {
            // === MAKANAN POKOK & SEMBAKO ===
            'beras': 'ğŸŒ¾', 'nasi': 'ğŸš', 'roti': 'ğŸ', 'gandum': 'ğŸŒ¾',
            'tepung': 'ğŸ¥¡', 'gula': 'ğŸ¬', 'garam': 'ğŸ§‚', 'minyak': 'ğŸŒ»',
            'mentega': 'ğŸ§ˆ', 'keju': 'ğŸ§€', 'telur': 'ğŸ¥š', 'madu': 'ğŸ¯',
            'mie': 'ğŸœ', 'indomie': 'ğŸœ', 'pasta': 'ğŸ', 'sereal': 'ğŸ¥£',

            // === LAUK PAUK (PROTEIN) ===
            'ayam': 'ğŸ—', 'daging': 'ğŸ¥©', 'sapi': 'ğŸ¥©', 'kambing': 'ğŸ–',
            'ikan': 'ğŸŸ', 'lele': 'ğŸŸ', 'udang': 'ğŸ¤', 'cumi': 'ğŸ¦‘',
            'kepiting': 'ğŸ¦€', 'sosis': 'ğŸŒ­', 'bakso': 'ğŸ¡', 'nugget': 'ğŸ±',
            'tahu': 'â¬œ', 'tempe': 'ğŸŸ«', // Kearifan lokal

            // === SAYURAN & BUMBU ===
            'sayur': 'ğŸ¥¬', 'bayam': 'ğŸŒ¿', 'kangkung': 'ğŸŒ¿', 'sawi': 'ğŸ¥¬',
            'brokoli': 'ğŸ¥¦', 'wortel': 'ğŸ¥•', 'jagung': 'ğŸŒ½', 'timun': 'ğŸ¥’',
            'terong': 'ğŸ†', 'kentang': 'ğŸ¥”', 'tomat': 'ğŸ…', 'jamur': 'ğŸ„',
            'cabe': 'ğŸŒ¶ï¸', 'sambal': 'ğŸŒ¶ï¸', 'bawang': 'ğŸ§…', 'baput': 'ğŸ§„',
            'jahe': 'ğŸ«š', 'alpukat': 'ğŸ¥‘', 'kacang': 'ğŸ¥œ', 'petai': 'ğŸ«›',

            // === BUAH-BUAHAN ===
            'buah': 'ğŸ', 'apel': 'ğŸ', 'jeruk': 'ğŸŠ', 'pisang': 'ğŸŒ',
            'anggur': 'ğŸ‡', 'semangka': 'ğŸ‰', 'melon': 'ğŸˆ', 'mangga': 'ğŸ¥­',
            'nanas': 'ğŸ', 'stroberi': 'ğŸ“', 'kelapa': 'ğŸ¥¥', 'durian': 'ğŸ¥Ÿ', // Emoji durian blm ada, pake dumpling mirip2 dikit

            // === MINUMAN ===
            'air': 'ğŸ’§', 'galon': 'ğŸ’§', 'aer': 'ğŸ’§', 'aqua': 'ğŸ’§',
            'susu': 'ğŸ¥›', 'kopi': 'â˜•', 'teh': 'ğŸµ', 'jus': 'ğŸ§ƒ',
            'sirup': 'ğŸ¹', 'soda': 'ğŸ¥¤', 'boba': 'ğŸ§‹', 'es': 'ğŸ§Š',
            'bir': 'ğŸº', 'yakult': 'ğŸ¼', 'yogurt': 'ğŸ¦',

            // === JAJANAN & SNACK ===
            'snack': 'ğŸ¿', 'ciki': 'ğŸ¿', 'keripik': 'ğŸ¥”', 'biskuit': 'ğŸª',
            'coklat': 'ğŸ«', 'permen': 'ğŸ¬', 'es krim': 'ğŸ¦', 'eskrim': 'ğŸ¦',
            'kue': 'ğŸ°', 'donat': 'ğŸ©', 'martabak': 'ğŸ¥', 'pizza': 'ğŸ•',
            'burger': 'ğŸ”', 'kentang goreng': 'ğŸŸ', 'popcorn': 'ğŸ¿',

            // === PERLENGKAPAN MANDI & CUCI ===
            'sabun': 'ğŸ§¼', 'shampo': 'ğŸ§´', 'odol': 'ğŸª¥', 'sikat gigi': 'ğŸª¥',
            'tisu': 'ğŸ§»', 'deterjen': 'ğŸ«§', 'rinso': 'ğŸ«§', 'pewangi': 'ğŸŒ¸',
            'pembalut': 'ğŸ©¸', 'popok': 'ğŸ‘¶', 'pampers': 'ğŸ‘¶', 'skincare': 'âœ¨',
            'bedak': 'ğŸ§–â€â™€ï¸', 'parfum': 'ğŸŒ¸', 'deodoran': 'ğŸ‘ƒ',

            // === KEBUTUHAN RUMAH & DAPUR ===
            'gas': 'ğŸ”¥', 'elpiji': 'ğŸ”¥', 'korek': 'ğŸ”¥', 'api': 'ğŸ”¥',
            'listrik': 'âš¡', 'token': 'âš¡', 'pulsa': 'ğŸ“±', 'paket data': 'ğŸ“¶',
            'baterai': 'ğŸ”‹', 'lampu': 'ğŸ’¡', 'kresek': 'ğŸ›ï¸', 'plastik': 'ğŸ›ï¸',
            'piring': 'ğŸ½ï¸', 'gelas': 'ğŸ¥‚', 'sapu': 'ğŸ§¹', 'pel': 'ğŸª£',
            'obat': 'ğŸ’Š', 'vitamin': 'ğŸ’Š', 'hansaplast': 'ğŸ©¹', 'masker': 'ğŸ˜·',

            // === FASHION & LAINNYA ===
            'baju': 'ğŸ‘•', 'kaos': 'ğŸ‘•', 'celana': 'ğŸ‘–', 'gaun': 'ğŸ‘—',
            'jaket': 'ğŸ§¥', 'sepatu': 'ğŸ‘Ÿ', 'sendal': 'ğŸ©´', 'kaus kaki': 'ğŸ§¦',
            'tas': 'ğŸ’', 'dompet': 'ğŸ‘›', 'kacamata': 'ğŸ‘“', 'topi': 'ğŸ§¢',
            'payung': 'ğŸŒ‚', 'helm': 'â›‘ï¸', 'rokok': 'ğŸš¬', 'vape': 'ğŸ’¨',
            'bensin': 'â›½', 'pertalite': 'â›½', 'pertamax': 'â›½',
            'makan kucing': 'ğŸ±', 'whiskas': 'ğŸ±', 'makan anjing': 'ğŸ¶'
        };

        // --- HELPERS ---
        function escapeHtml(text) {
            if(!text) return "";
            return String(text).replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;");
        }

        const formatRupiah = (num) => new Intl.NumberFormat('id-ID', {style: 'currency', currency: 'IDR', minimumFractionDigits: 0}).format(num);

        window.formatRupiahTyping = function(input) {
            let value = input.value.replace(/\D/g, '');
            if (value === "") { input.value = ""; return; }
            input.value = value.replace(/\B(?=(\d{3})+(?!\d))/g, ".");
        }

        function playSound(type) {
            resumeAudioContext();
            const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain();
            osc.connect(gain); gain.connect(audioCtx.destination);
            const now = audioCtx.currentTime;
            if (type === 'add') { osc.type = 'sine'; osc.frequency.setValueAtTime(600, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.1); osc.start(now); osc.stop(now+0.1); }
            else if (type === 'check') { osc.type = 'triangle'; osc.frequency.setValueAtTime(1200, now); gain.gain.exponentialRampToValueAtTime(0.01, now+0.3); osc.start(now); osc.stop(now+0.3); }
            else if (type === 'delete') { osc.type = 'sawtooth'; osc.frequency.setValueAtTime(150, now); gain.gain.linearRampToValueAtTime(0.01, now+0.2); osc.start(now); osc.stop(now+0.2); }
            else if (type === 'fanfare') {
                [523.25, 659.25, 783.99, 1046.50].forEach((freq, i) => {
                    const o = audioCtx.createOscillator(); const g = audioCtx.createGain();
                    o.connect(g); g.connect(audioCtx.destination);
                    o.type = 'triangle'; o.frequency.value = freq;
                    g.gain.setValueAtTime(0.1, now + (i*0.1)); g.gain.exponentialRampToValueAtTime(0.01, now + (i*0.1) + 0.4);
                    o.start(now + (i*0.1)); o.stop(now + (i*0.1) + 0.4);
                });
            }
        }
        
        function showToast(msg) {
            const t = getEl('toast');
            if(t) {
                t.innerText = msg;
                t.classList.add('show');
                setTimeout(() => t.classList.remove('show'), 3000);
            }
        }

        function triggerHaptic() { if (navigator.vibrate) navigator.vibrate(15); }

        window.scrollRequesterList = function(direction) {
            const container = getEl('requester-scroll-container');
            const itemStride = 92; 
            const scrollAmount = itemStride * 4; 
            container.scrollBy({ left: direction * scrollAmount, behavior: 'smooth' });
        }

        window.checkScrollPosition = function() {
            const container = getEl('requester-scroll-container');
            const scrollLeft = container.scrollLeft;
            const maxScroll = container.scrollWidth - container.clientWidth;
            
            const leftBtn = getEl('scroll-left-btn');
            const rightBtn = getEl('scroll-right-btn');
            const fadeRight = getEl('fade-right');

            if (leftBtn) {
                if (scrollLeft <= 5) leftBtn.classList.add('hidden');
                else leftBtn.classList.remove('hidden');
            }

            if (rightBtn) {
                if (scrollLeft >= maxScroll - 5) rightBtn.classList.add('hidden');
                else rightBtn.classList.remove('hidden');
            }

            if(fadeRight) {
                if (scrollLeft >= maxScroll - 10) fadeRight.style.opacity = '0';
                else fadeRight.style.opacity = '1';
            }

            const dots = document.querySelectorAll('.scroll-dot');
            let activeIndex = 0;
            if (maxScroll > 0) {
                const progress = scrollLeft / maxScroll;
                if (progress > 0.66) activeIndex = 2;
                else if (progress > 0.33) activeIndex = 1;
                else activeIndex = 0;
            }
            
            dots.forEach((dot, idx) => {
                if (idx === activeIndex) { dot.classList.remove('bg-gray-300', 'scale-75'); dot.classList.add('bg-green-500', 'scale-100'); } 
                else { dot.classList.add('bg-gray-300', 'scale-75'); dot.classList.remove('bg-green-500', 'scale-100'); }
            });
        }

        function initSwipeToClose(modalId, closeCallback) {
            const modal = getEl(modalId);
            if (!modal) return;
            const content = modal.querySelector('.slide-up'); 
            if (!content) return;

            let startY = 0; let currentY = 0; let isDragging = false;

            content.addEventListener('touchstart', (e) => {
                if (content.scrollTop === 0) { startY = e.touches[0].clientY; isDragging = true; content.style.transition = 'none'; }
            }, {passive: true});

            content.addEventListener('touchmove', (e) => {
                if (!isDragging) return;
                const deltaY = e.touches[0].clientY - startY;
                if (deltaY > 0) { currentY = deltaY; content.style.transform = `translateY(${deltaY}px)`; }
            }, {passive: true});

            content.addEventListener('touchend', (e) => {
                if (!isDragging) return;
                isDragging = false;
                content.style.transition = 'transform 0.3s ease-out';
                if (currentY > 120) { content.style.transform = 'translateY(100%)'; setTimeout(() => { closeCallback(); content.style.transform = ''; }, 300); } 
                else { content.style.transform = ''; }
                currentY = 0;
            });
        }
        
        function updateProgress() { 
            const t=items.length; 
            const c=items.filter(i=>i.checked).length; 
            const p=t===0?0:Math.round((c/t)*100); 
            
            if(DOM.progressBar) DOM.progressBar.style.width=`${p}%`;
            if(DOM.progressText) DOM.progressText.innerText=`${c}/${t} Selesai`;
            if(DOM.progressPercent) DOM.progressPercent.innerText=`${p}%`; 
        }

        // --- CONTROLLERS ---
        window.openModal = function() { 
            triggerHaptic(); 
            resumeAudioContext();
            DOM.modal.classList.remove('hidden'); 
            DOM.modal.classList.add('flex'); 
            setTimeout(() => {
                window.checkScrollPosition();
                DOM.input.focus();
            }, 100); 
        }
        window.closeModal = function() { DOM.modal.classList.remove('flex'); DOM.modal.classList.add('hidden'); }
        
        window.openReportModal = function() { triggerHaptic(); DOM.reportModal.classList.remove('hidden'); DOM.reportModal.classList.add('flex'); updateReportUI(); }
        window.closeReportModal = function() { DOM.reportModal.classList.remove('flex'); DOM.reportModal.classList.add('hidden'); }
        
        window.openResetModal = function() { triggerHaptic(); DOM.resetModal.classList.remove('hidden'); DOM.resetModal.classList.add('flex'); }
        window.closeResetModal = function() { DOM.resetModal.classList.remove('flex'); DOM.resetModal.classList.add('hidden'); }
        
        window.openDeleteModal = function(index) { triggerHaptic(); itemToDeleteIndex=index; DOM.deleteModal.classList.remove('hidden'); DOM.deleteModal.classList.add('flex'); }
        window.closeDeleteModal = function() { DOM.deleteModal.classList.remove('flex'); DOM.deleteModal.classList.add('hidden'); itemToDeleteIndex=null; }
        
        window.openCancelModal = function(index) { itemToUncheckIndex = index; DOM.cancelModal.classList.remove('hidden'); DOM.cancelModal.classList.add('flex'); }
        window.closeCancelModal = function() { DOM.cancelModal.classList.remove('flex'); DOM.cancelModal.classList.add('hidden'); itemToUncheckIndex = null; }

        window.openClearHistoryModal = function() { triggerHaptic(); DOM.clearHistoryModal.classList.remove('hidden'); DOM.clearHistoryModal.classList.add('flex'); }
        window.closeClearHistoryModal = function() { DOM.clearHistoryModal.classList.remove('flex'); DOM.clearHistoryModal.classList.add('hidden'); }

        window.openReimburseModal = function() {
            triggerHaptic();
            DOM.reimburseList.classList.remove('hidden');
            DOM.reimburseDetail.classList.add('hidden');
            DOM.reimburseFooter.classList.add('hidden'); 
            DOM.reimburseList.innerHTML = '';
            let hasHistory = false;
            [...expenseHistory].reverse().forEach((record, recIndex) => {
                let unpaidItems = 0; let totalUnpaid = 0;
                if(record.items) {
                    record.items.forEach(item => {
                        if(typeof item === 'object' && !item.reimbursed && item.user !== 'Saya') {
                            unpaidItems++; totalUnpaid += parseInt(item.price) || 0;
                        }
                    });
                }
                if(unpaidItems > 0) {
                    hasHistory = true;
                    const realRecIndex = expenseHistory.length - 1 - recIndex;
                    const div = document.createElement('div');
                    div.className = 'py-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors flex justify-between items-center';
                    div.onclick = () => showReimburseDetail(realRecIndex);
                    div.innerHTML = `<div><p class="font-bold text-gray-700">${new Date(record.date).toLocaleDateString('id-ID', {weekday:'short', day:'numeric', month:'short'})}</p><p class="text-xs text-gray-400 mt-0.5">${unpaidItems} Barang belum diganti</p></div><div class="text-right"><p class="font-bold text-blue-600">${formatRupiah(totalUnpaid)}</p><i class="fas fa-chevron-right text-gray-300 text-xs"></i></div>`;
                    DOM.reimburseList.appendChild(div);
                }
            });
            if(!hasHistory) DOM.reimburseList.innerHTML = '<div class="text-center py-10 text-gray-400 flex flex-col items-center"><i class="fas fa-check-circle text-4xl mb-2 text-green-200"></i><p>Semua barang sudah lunas!</p></div>';
            DOM.reimburseModal.classList.remove('hidden'); DOM.reimburseModal.classList.add('flex');
        }
        
        function showReimburseDetail(realIndex) {
            currentReimburseIndex = realIndex;
            const record = expenseHistory[realIndex];
            DOM.reimburseItemsContainer.innerHTML = '';
            DOM.reimburseList.classList.add('hidden');
            DOM.reimburseDetail.classList.remove('hidden'); DOM.reimburseDetail.classList.add('flex');
            DOM.reimburseFooter.classList.remove('hidden'); DOM.reimburseFooter.classList.add('block');
            
            record.items.forEach((item, idx) => {
                if(typeof item === 'object' && !item.reimbursed && item.user !== 'Saya') {
                    const div = document.createElement('div');
                    div.className = 'flex items-center p-3 border-b border-gray-100 last:border-0';
                    div.innerHTML = `<input type="checkbox" id="reimburse-item-${idx}" class="w-5 h-5 text-blue-600 rounded border-gray-300 focus:ring-blue-500 mr-3 reimburse-check" data-price="${item.price}" data-idx="${idx}"><label for="reimburse-item-${idx}" class="flex-1 cursor-pointer"><div class="flex justify-between"><span class="font-bold text-gray-700 text-sm">${escapeHtml(item.name)}</span><span class="font-bold text-blue-600 text-sm">${formatRupiah(item.price)}</span></div><p class="text-[10px] text-gray-400">Nitip: ${escapeHtml(item.user)}</p></label>`;
                    DOM.reimburseItemsContainer.appendChild(div);
                }
            });
            document.querySelectorAll('.reimburse-check').forEach(chk => { chk.addEventListener('change', updateReimburseTotal); });
            updateReimburseTotal(); 
        }
        
        window.backToReimburseList = function() {
            DOM.reimburseDetail.classList.add('hidden'); DOM.reimburseDetail.classList.remove('flex');
            DOM.reimburseFooter.classList.add('hidden'); DOM.reimburseFooter.classList.remove('block');
            DOM.reimburseList.classList.remove('hidden');
            currentReimburseIndex = null;
        }

        window.closeReimburseModal = function() { DOM.reimburseModal.classList.remove('flex'); DOM.reimburseModal.classList.add('hidden'); window.backToReimburseList(); }

        function updateReimburseTotal() {
            let total = 0;
            document.querySelectorAll('.reimburse-check:checked').forEach(chk => { total += parseInt(chk.dataset.price) || 0; });
            DOM.reimburseTotal.innerText = formatRupiah(total);
        }

        window.confirmReimbursement = function() {
            const checks = document.querySelectorAll('.reimburse-check:checked');
            if (checks.length === 0) { alert("Pilih barang dulu!"); return; }
            let totalReimbursed = 0; let itemsNames = [];
            checks.forEach(chk => {
                const itemIdx = parseInt(chk.dataset.idx); const price = parseInt(chk.dataset.price);
                expenseHistory[currentReimburseIndex].items[itemIdx].reimbursed = true;
                totalReimbursed += price; itemsNames.push(expenseHistory[currentReimburseIndex].items[itemIdx].name);
            });
            try { localStorage.setItem('familyExpenses', JSON.stringify(expenseHistory)); } catch(e){}
            const now = new Date();
            incomeHistory.push({ date: now.toISOString().split('T')[0], timestamp: now.toISOString(), amount: totalReimbursed, note: `Ganti: ${itemsNames.join(', ')}` });
            try { localStorage.setItem('familyIncomes', JSON.stringify(incomeHistory)); } catch(e){}
            showToast("Berhasil Diganti & Dipotong!"); playSound('check'); window.closeReimburseModal(); updateReportUI();
        }

        window.openReceiptModal = function() { 
            const total = items.length; const checkedCount = items.filter(i => i.checked).length;
            if (total === 0 || checkedCount < total) { alert("Selesaikan semua belanjaan dulu baru bisa lihat struk!"); return; }
            triggerHaptic(); DOM.receiptModal.classList.remove('hidden'); renderReceiptContent(items.filter(i=>i.checked), new Date().toLocaleString('id-ID')); 
        }
        window.closeReceiptModal = function() { DOM.receiptModal.classList.remove('flex'); DOM.receiptModal.classList.add('hidden'); }
        
        window.openCelebration = function() { 
            playSound('fanfare'); 
            let t=0; items.forEach(i=>{if(i.checked)t+=(parseInt(i.price)||0)}); 
            DOM.celTotal.innerText=formatRupiah(t); DOM.celebrationModal.classList.remove('hidden'); DOM.celebrationModal.classList.add('flex'); 
        }
        window.closeCelebration = function() { DOM.celebrationModal.classList.remove('flex'); DOM.celebrationModal.classList.add('hidden'); }

        function renderList() {
            if (!DOM.list) return;
            DOM.list.innerHTML = '';
            let totalSpent = 0; let countBought = 0;

            if (items.length === 0) {
                if(DOM.empty) { DOM.list.appendChild(DOM.empty); DOM.empty.classList.remove('hidden'); }
            } else {
                if(DOM.empty) DOM.empty.classList.add('hidden');
                items.sort((a, b) => a.checked - b.checked);
                const total = items.length; const checkedCount = items.filter(i => i.checked).length;

                items.forEach((item, index) => {
                    const itemPrice = parseInt(item.price) || 0;
                    if(item.checked) { totalSpent += itemPrice; countBought++; }
                    const div = document.createElement('div');
                    const bgClass = item.checked ? 'bg-gray-50 border-gray-100' : 'bg-white border-green-50 shadow-sm';
                    const opacityClass = item.checked ? 'opacity-70' : 'opacity-100';
                    let displayIcon = 'ğŸ›ï¸';
                    for (let key in emojiMap) { if (item.itemName.toLowerCase().includes(key)) { displayIcon = emojiMap[key]; break; } }
                    const priceLabel = item.checked ? formatRupiah(itemPrice) : "Belum Dibeli";
                    const priceColor = item.checked ? 'text-green-600' : 'text-gray-400';
                    div.className = `flex items-center p-4 mb-3 rounded-2xl border ${bgClass} ${opacityClass} transition-all duration-300`;
                    div.innerHTML = `<div onclick="window.handleCheckClick(${index})" class="cursor-pointer mr-4"><div class="w-6 h-6 rounded-full border-2 flex items-center justify-center transition-all ${item.checked ? 'bg-green-500 border-green-500 text-white' : 'border-gray-300'}">${item.checked ? '<i class="fas fa-check text-[10px]"></i>' : ''}</div></div><div class="flex-1 cursor-pointer" onclick="window.handleCheckClick(${index})"><h4 class="text-lg font-bold text-gray-800 ${item.checked ? 'line-through text-gray-400' : ''}">${displayIcon} ${escapeHtml(item.itemName)}</h4><p class="text-sm font-bold ${priceColor} mt-0.5">${priceLabel}</p><div class="flex items-center gap-2 mt-1"><span class="badge-user ${item.userColor}">${item.userEmoji} ${escapeHtml(item.userName)}</span><span class="text-[10px] text-gray-400">â€¢ ${item.time}</span></div></div><button onclick="window.openDeleteModal(${index})" class="w-8 h-8 rounded-full flex items-center justify-center text-gray-300 hover:bg-red-50 hover:text-red-500 transition-colors ml-2"><i class="fas fa-trash text-sm"></i></button>`;
                    DOM.list.appendChild(div);
                });

                if (total > 0 && checkedCount === total) {
                    const bannerContainer = document.createElement('div');
                    bannerContainer.className = 'flex flex-col gap-3 mb-4';
                    const successBanner = `<div class="bg-green-100 border-2 border-green-200 text-green-700 px-4 py-3 rounded-2xl flex flex-col gap-3 shadow-sm animate-pulse"><div class="flex items-center gap-3"><div class="w-10 h-10 bg-green-500 rounded-full flex items-center justify-center text-white shrink-0"><i class="fas fa-check"></i></div><div><p class="font-bold text-sm">Semua Selesai!</p><p class="text-xs">Hati-hati di jalan, sampai jumpa!</p></div></div><button onclick="window.openReceiptModal()" class="w-full py-2 bg-white text-green-700 font-bold rounded-xl text-sm hover:bg-green-50 transition-colors">Lihat Struk Belanja</button></div>`;
                    const refreshButton = `<button onclick="window.openResetModal()" class="w-full py-3 bg-blue-600 text-white font-bold rounded-2xl text-sm hover:bg-blue-700 shadow-lg shadow-blue-200 transition-transform active:scale-95 flex items-center justify-center gap-2">Mulai Belanja Baru <i class="fas fa-redo-alt"></i></button>`;
                    bannerContainer.innerHTML = successBanner + refreshButton;
                    DOM.list.prepend(bannerContainer);
                }
            }
            if(DOM.totalSpent) DOM.totalSpent.innerText = formatRupiah(totalSpent);
            if(DOM.itemCount) DOM.itemCount.innerText = countBought;
            updateProgress(); saveData();
        }

        window.addItem = function() {
            triggerHaptic(); resumeAudioContext();
            const itemName = DOM.input.value.trim();
            if (itemName) {
                const now = new Date(); const time = now.getHours()+':'+String(now.getMinutes()).padStart(2,'0');
                if(DOM.customReq.value.trim()) currentRequester = {name:DOM.customReq.value, emoji:'ğŸ‘¤', colorClass:'bg-gray-100'};
                items.unshift({ itemName: itemName, checked: false, price: 0, time: time, userName: currentRequester.name, userEmoji: currentRequester.emoji, userColor: currentRequester.colorClass });
                playSound('add'); DOM.input.value = ''; DOM.customReq.value = ''; window.closeModal(); renderList();
            }
        }

        window.handleCheckClick = function(index) {
            triggerHaptic(); const item = items[index];
            if (!item.checked) {
                itemToPriceIndex = index; DOM.priceName.innerText = item.itemName; DOM.priceInput.value = '';
                DOM.priceModal.classList.remove('hidden'); DOM.priceModal.classList.add('flex'); setTimeout(()=>DOM.priceInput.focus(),100);
            } else { window.openCancelModal(index); }
        }

        window.confirmItemPrice = function() {
            if (itemToPriceIndex !== null) {
                const val = DOM.priceInput.value.replace(/\./g,'');
                items[itemToPriceIndex].price = val ? parseInt(val) : 0;
                items[itemToPriceIndex].checked = true;
                playSound('check');
                DOM.priceModal.classList.add('hidden'); DOM.priceModal.classList.remove('flex'); itemToPriceIndex=null;
                renderList();
                const total = items.length; const checkedCount = items.filter(i => i.checked).length;
                if (total > 0 && checkedCount === total) setTimeout(() => window.openCelebration(), 400);
            }
        }

        window.confirmUncheck = function() {
            if (itemToUncheckIndex !== null) { items[itemToUncheckIndex].checked = false; renderList(); window.closeCancelModal(); }
        }
        
        window.confirmNewSession = function() {
             window.closeResetModal(); window.closeCelebration();
             const bought = items.filter(i=>i.checked);
             if(bought.length > 0){
                 const now = new Date();
                 let t=0; bought.forEach(i=>t+=parseInt(i.price)||0);
                 expenseHistory.push({ date: now.toISOString().split('T')[0], timestamp: now.toISOString(), total: t, count: bought.length, items: bought.map(i => ({ name: i.itemName, price: i.price, user: i.userName, reimbursed: false })) });
                 try { localStorage.setItem('familyExpenses', JSON.stringify(expenseHistory)); } catch(e){}
                 showToast("Disimpan ke Riwayat");
             }
             items=[]; saveData(); renderList(); 
        }

        window.confirmClearHistory = function() {
            expenseHistory=[]; incomeHistory=[]; 
            try { localStorage.setItem('familyExpenses',JSON.stringify([])); localStorage.setItem('familyIncomes',JSON.stringify([])); } catch(e){}
            updateReportUI(); window.closeClearHistoryModal(); showToast("Semua Riwayat Dihapus");
        }

        window.confirmDelete = function() { if(itemToDeleteIndex!==null){ items.splice(itemToDeleteIndex,1); playSound('delete'); renderList(); window.closeDeleteModal(); } }

        function renderReceiptContent(dataItems, dateString) {
             DOM.receiptDate.innerText = `Tanggal: ${dateString}`;
             if(DOM.printDate) DOM.printDate.innerText = `Tanggal: ${dateString}`;
             
             let html=''; let total=0;
             dataItems.forEach(i=>{ 
                 const price = parseInt(i.price)||0; total += price; 
                 html+=`<tr><td class="col-item">${escapeHtml(i.itemName)}</td><td class="col-user">${escapeHtml(i.userName)}</td><td class="col-price">${price > 0 ? formatRupiah(price) : '-'}</td></tr>`; 
             });
             
             const emptyHtml = '<tr><td colspan="3" class="text-center italic opacity-50 py-4">Data tidak lengkap</td></tr>';
             if(DOM.receiptBody) DOM.receiptBody.innerHTML = html || emptyHtml;
             if(DOM.receiptTotal) DOM.receiptTotal.innerText = formatRupiah(total);
             if(DOM.printBody) DOM.printBody.innerHTML = html || emptyHtml;
             if(DOM.printTotal) DOM.printTotal.innerText = formatRupiah(total);
        }

        function updateReportUI() { 
            const now = new Date(); const todayStr = now.toISOString().split('T')[0];
            const currentMonth = now.getMonth(); const currentYear = now.getFullYear();
            let totalToday = 0; let totalMonthExpense = 0; let totalMonthIncome = 0; let historyHTML = '';
            
            let activeTotal = 0; let activeCount = 0;
            items.forEach(item => { if (item.checked) { activeTotal += (parseInt(item.price) || 0); activeCount++; } });
            
            if (activeTotal > 0) { 
                totalToday += activeTotal; totalMonthExpense += activeTotal; 
                historyHTML += `<div class="flex justify-between items-center py-3 border-b border-green-100 bg-green-50/50 rounded-lg px-2 mb-2"><div><p class="font-bold text-green-700">Sedang Berjalan ğŸ›’</p><p class="text-xs text-green-500">${activeCount} Barang</p></div><p class="font-bold text-green-700">${formatRupiah(activeTotal)}</p></div>`; 
            }

            const sortedHistory = [...expenseHistory].reverse();
            sortedHistory.forEach((record, index) => {
                const recDate = new Date(record.date);
                let recTotalUnreimbursed = 0;
                if(record.items) {
                    record.items.forEach(itm => {
                        if(typeof itm === 'object' && !itm.reimbursed) { recTotalUnreimbursed += (parseInt(itm.price) || 0); } 
                        else if (typeof itm !== 'object') { recTotalUnreimbursed = record.total; }
                    });
                } else { recTotalUnreimbursed = record.total; }

                if(record.date === todayStr) totalToday += recTotalUnreimbursed;
                if(recDate.getMonth()===currentMonth && recDate.getFullYear()===currentYear) totalMonthExpense += recTotalUnreimbursed;
                
                const dateDisplay = recDate.toLocaleDateString('id-ID', { day: 'numeric', month: 'short', year: 'numeric' });
                const timeDisplay = record.timestamp ? new Date(record.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}).replace('.',':') : '';
                const amountDisplay = recTotalUnreimbursed === 0 ? '<span class="text-green-500 text-xs font-bold">LUNAS</span>' : formatRupiah(recTotalUnreimbursed);

                historyHTML += `<div onclick="window.openHistoryDetail(${index})" class="py-3 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors active:scale-95"><div class="flex justify-between items-center"><div><div class="flex items-center gap-2"><p class="font-bold text-gray-700">${dateDisplay}</p>${timeDisplay ? `<span class="text-xs text-gray-400 font-normal bg-gray-100 px-1.5 py-0.5 rounded-md">${timeDisplay}</span>` : ''}</div><p class="text-xs text-gray-400 mt-1">${record.count} Barang <span class="text-[10px] ml-1 text-blue-500">(Klik untuk detail)</span></p></div><div class="text-right"><p class="font-bold text-gray-600">${amountDisplay}</p><i class="fas fa-chevron-right text-gray-300 text-xs mt-1"></i></div></div></div>`;
            });

            incomeHistory.forEach(inc => {
                const incDate = new Date(inc.date);
                if(incDate.getMonth()===currentMonth && incDate.getFullYear()===currentYear) { totalMonthIncome += (parseInt(inc.amount) || 0); }
            });

            DOM.reportToday.innerText = formatRupiah(totalToday);
            DOM.reportMonth.innerText = formatRupiah(totalMonthExpense);
            DOM.totalIncome.innerText = `Sudah Diganti: ${formatRupiah(totalMonthIncome)}`;
            DOM.historyList.innerHTML = historyHTML || '<p class="text-gray-400 text-center italic py-4">Belum ada riwayat belanja.</p>';

            const banner = DOM.monthBanner;
            const emotionEl = DOM.monthEmotion;
            const statusEl = DOM.monthStatus;
            
            banner.className = 'p-5 rounded-2xl text-white shadow-lg mb-6 relative overflow-hidden transition-all duration-500 bg-gradient-to-br';
            emotionEl.className = 'text-6xl absolute right-4 top-1/2 -translate-y-1/2 opacity-80 filter drop-shadow-md transition-all duration-500';

            if (totalMonthExpense < 100000) {
                banner.classList.add('from-green-500', 'to-emerald-600'); emotionEl.classList.add('animate-float'); emotionEl.innerText = 'ğŸ˜'; statusEl.innerText = 'Masih Hemat, Mantap!';
            } else if (totalMonthExpense >= 100000 && totalMonthExpense < 500000) {
                banner.classList.add('from-yellow-500', 'to-orange-500'); emotionEl.classList.add('animate-float'); emotionEl.innerText = 'ğŸ˜¬'; statusEl.innerText = 'Waduh, Mulai Boros nih!';
            } else if (totalMonthExpense >= 500000 && totalMonthExpense < 1000000) {
                banner.classList.add('from-red-500', 'to-pink-600'); emotionEl.classList.add('animate-shake'); emotionEl.innerText = 'ğŸ˜­'; statusEl.innerText = 'Hati-hati, Dompet Nangis!';
            } else {
                banner.classList.add('from-purple-600', 'to-rose-900'); emotionEl.classList.add('animate-pulse'); emotionEl.innerText = 'ğŸ’€'; statusEl.innerText = 'Bener-bener Boros Ampun!';
            }
        }

        window.openHistoryDetail = function(reversedIndex) {
            triggerHaptic();
            const realIndex = expenseHistory.length - 1 - reversedIndex;
            const record = expenseHistory[realIndex];
            currentDetailIndex = realIndex;
            const dateDisplay = new Date(record.date).toLocaleDateString('id-ID', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            const timeDisplay = record.timestamp ? new Date(record.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}).replace('.',':') : '';
            DOM.detailDate.innerText = `${dateDisplay} ${timeDisplay ? 'â€¢ ' + timeDisplay : ''}`;
            DOM.detailTotal.innerText = formatRupiah(record.total);
            
            let listHtml = '';
            if (record.items && record.items.length > 0) {
                record.items.forEach(item => {
                    let name = item; let price = 0; let user = '-'; let isReimbursed = false;
                    if (typeof item === 'object') { name = item.name; price = parseInt(item.price) || 0; user = item.user; isReimbursed = item.reimbursed; }
                    listHtml += `<div class="flex justify-between items-center py-2 border-b border-gray-100 last:border-0"><div class="flex-1"><p class="font-bold text-sm ${isReimbursed ? 'text-gray-400 line-through' : 'text-gray-700'}">${escapeHtml(name)}</p><p class="text-[10px] text-gray-400">Nitip: ${escapeHtml(user)}</p></div><div class="text-right"><p class="font-bold text-sm ${isReimbursed ? 'text-gray-300' : 'text-gray-600'}">${price > 0 ? formatRupiah(price) : '-'}</p>${isReimbursed ? '<span class="text-[9px] text-green-500 font-bold bg-green-50 px-1 rounded">LUNAS</span>' : ''}</div></div>`;
                });
            } else { listHtml = '<p class="text-sm text-gray-400 italic text-center">Detail barang tidak tersedia untuk riwayat lama.</p>'; }
            DOM.detailItemsList.innerHTML = listHtml;
            DOM.btnViewReceipt.onclick = function() { window.viewHistoryReceipt(realIndex); };
            DOM.historyDetailModal.classList.remove('hidden'); DOM.historyDetailModal.classList.add('flex');
        }

        window.closeHistoryDetailModal = function() { DOM.historyDetailModal.classList.remove('flex'); DOM.historyDetailModal.classList.add('hidden'); }
        window.viewHistoryReceipt = function(realIndex) {
            triggerHaptic(); const record = expenseHistory[realIndex]; let historyItems = [];
            if (record.items && record.items.length > 0) { historyItems = record.items.map(i => { if (typeof i === 'object') { return { itemName: i.name, userName: i.user || '-', price: i.price }; } else { return { itemName: i, userName: '-', price: 0 }; } }); }
            const recDate = new Date(record.date).toLocaleDateString('id-ID', {weekday: 'long', year: 'numeric', month: 'long', day: 'numeric'});
            const recTime = record.timestamp ? new Date(record.timestamp).toLocaleTimeString('id-ID', {hour: '2-digit', minute:'2-digit'}).replace('.',':') : '';
            DOM.receiptModal.classList.remove('hidden'); 
            renderReceiptContent(historyItems, `${recDate} ${recTime}`);
        }

        window.saveAsImage = function() { 
            triggerHaptic(); 
            const target = DOM.receiptTarget;
            const temp = target.cloneNode(true);
            temp.style.position = 'absolute'; temp.style.top = '0'; temp.style.left = '-9999px'; temp.style.zIndex = '-1'; temp.style.display = 'block'; temp.style.opacity = '1'; temp.style.width = '380px'; 
            document.body.appendChild(temp);
            html2canvas(temp, { scale: 2, backgroundColor: null, useCORS: true, allowTaint: true }).then(c => { 
                const a = document.createElement("a"); a.download = "Struk-KeranjangKita.jpg"; a.href = c.toDataURL("image/jpeg", 0.9); a.click(); document.body.removeChild(temp);
            }).catch(err => { console.error("Error capturing image:", err); alert("Gagal menyimpan gambar. Silakan coba lagi."); document.body.removeChild(temp); }); 
        }
        
        window.printReceipt = function() { 
            triggerHaptic(); 
            const content = DOM.receiptTarget.innerHTML; 
            const w = window.open('', '', 'height=600,width=400');
            w.document.write('<html><head><title>Struk Belanja</title>'); 
            w.document.write('<link href="https://fonts.googleapis.com/css2?family=Inconsolata:wght@400;700&display=swap" rel="stylesheet">');
            w.document.write(`<style> body { font-family: 'Inconsolata', monospace; padding: 20px; text-align: center; } .receipt-paper { max-width: 300px; margin: 0 auto; border: 1px solid #ddd; padding: 20px; position: relative; -webkit-print-color-adjust: exact; print-color-adjust: exact; } .receipt-paper::after { content: ""; position: absolute; left: 0; bottom: -8px; width: 100%; height: 10px; background: radial-gradient(circle, transparent, transparent 50%, #fff 50%, #fff 100%) -7px -2px / 15px 15px repeat-x; -webkit-print-color-adjust: exact; print-color-adjust: exact; } h2 { margin: 0; font-size: 18px; text-transform: uppercase; border-bottom: 2px dashed #000; padding-bottom: 10px; margin-bottom: 10px; font-family: sans-serif; font-weight: bold; } .receipt-table { width: 100%; border-collapse: collapse; text-align: left; font-size: 12px; margin-top: 10px; } .receipt-table td { padding: 6px 0; border-bottom: 1px dashed #9ca3af; } .col-item { width: 55%; } .col-user { width: 15%; text-align: right; font-style: italic; color: #666; font-size: 10px; white-space: nowrap; } .col-price { width: 30%; text-align: right; font-weight: bold; } .total-section { margin-top: 15px; border-top: 2px dashed #000; padding-top: 10px; display: flex; justify-content: space-between; font-weight: bold; font-size: 14px; } .footer { margin-top: 20px; font-size: 10px; color: #888; } </style>`); 
            
            // PATCH: ESCAPE HTML END TAGS IN STRINGS TO PREVENT PARSER ERRORS
            w.document.write('<\/head><body>'); 
            w.document.write('<div class="receipt-paper">'); 
            w.document.write(content); 
            w.document.write('<\/div>'); 
            w.document.write('<\/body><\/html>'); 
            
            w.document.close(); 
            w.focus(); 
            setTimeout(() => { w.print(); w.close(); }, 500);
        }
        
        window.copyReceiptText = function() { 
            triggerHaptic(); 
            const date = DOM.receiptDate.innerText; 
            const rows = document.querySelectorAll('#receipt-items-body tr'); 
            const total = DOM.receiptTotal.innerText;
            
            let text = "ğŸ›’ *STRUK KERANJANG KITA*\n------------------\n"; text += date + "\n\n";
            rows.forEach(row => { 
                const name = row.querySelector('.col-item')?.innerText || ''; 
                const user = row.querySelector('.col-user')?.innerText || ''; 
                const price = row.querySelector('.col-price')?.innerText || ''; 
                if(name) text += `${name} (${user}) : ${price}\n`; 
            });
            text += "------------------\n"; text += `TOTAL: ${total}\n\n`; text += "App by Keranjang Kita";
            
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(text).then(() => showToast("Teks Struk Disalin!")).catch(() => fallbackCopyText(text));
            } else { fallbackCopyText(text); }
        }

        function fallbackCopyText(text) {
            const textArea = document.createElement("textarea");
            textArea.value = text;
            textArea.style.top = "0"; textArea.style.left = "0"; textArea.style.position = "fixed"; textArea.style.opacity = "0"; 
            document.body.appendChild(textArea);
            textArea.focus(); textArea.select();
            try {
                const successful = document.execCommand('copy');
                if(successful) showToast("Teks Struk Disalin!");
                else prompt("Gagal auto-copy. Silakan salin manual:", text);
            } catch (err) { prompt("Gagal auto-copy. Silakan salin manual:", text); }
            document.body.removeChild(textArea);
        }

        window.selectRequester = function(name, emoji, colorClass, btn) { triggerHaptic(); currentRequester = { name, emoji, colorClass }; document.querySelectorAll('.requester-btn').forEach(b => b.classList.remove('active')); if(btn) btn.classList.add('active'); DOM.customReq.value = ''; }
        window.handleCustomRequester = function(input) { const val = input.value.trim(); if (val.length > 0) { currentRequester = { name: val, emoji: 'ğŸ‘¤', colorClass: 'bg-gray-100 text-gray-700' }; document.querySelectorAll('.requester-btn').forEach(b => b.classList.remove('active')); } }

        DOM.priceInput.addEventListener('keypress', (e)=>{if(e.key==='Enter')window.confirmItemPrice()});
        DOM.input.addEventListener('keypress', (e)=>{if(e.key==='Enter')window.addItem()});
        
        function saveData() { try { localStorage.setItem('familyItems', JSON.stringify(items)); } catch(e){} }

        window.onclick = function(e) {
            if(e.target==DOM.modal) window.closeModal();
            if(e.target==DOM.deleteModal) window.closeDeleteModal();
            if(e.target==DOM.cancelModal) window.closeCancelModal();
            if(e.target==DOM.celebrationModal) window.closeCelebration();
            if(e.target==DOM.reportModal) window.closeReportModal();
            if(e.target==DOM.receiptModal) window.closeReceiptModal();
            if(e.target==DOM.historyDetailModal) window.closeHistoryDetailModal();
            if(e.target==DOM.resetModal) window.closeResetModal();
            if(e.target==DOM.clearHistoryModal) window.closeClearHistoryModal();
            if(e.target==DOM.reimburseModal) window.closeReimburseModal();
        }
        
        initSwipeToClose('modal', window.closeModal);
        initSwipeToClose('report-modal', window.closeReportModal);
        initSwipeToClose('history-detail-modal', window.closeHistoryDetailModal);
        initSwipeToClose('reimburse-modal', window.closeReimburseModal);

        const styleSheet = document.createElement("style"); styleSheet.innerText = `@keyframes fall { 0% { transform: translateY(-10vh) rotate(0deg); opacity: 1; } 100% { transform: translateY(100vh) rotate(720deg); opacity: 0; } }`; document.head.appendChild(styleSheet);
        renderList();
    </script>
</body>
</html>